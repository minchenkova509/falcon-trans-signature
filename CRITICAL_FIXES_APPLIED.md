# üîß –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

## üêõ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**

### **1. –°–º–µ—â–µ–Ω–∏–µ –ø–µ—á–∞—Ç–∏ –≤ –æ–¥–∏–Ω–æ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ**
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–µ—á–∞—Ç—å "—Å—ä–µ–∑–∂–∞–ª–∞" –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö —Å `/Rotate` –∏–ª–∏ `CropBox ‚â† MediaBox`

**–†–µ—à–µ–Ω–∏–µ**: 
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `merge_on_page()` —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–∏
- ‚úÖ –£—á–µ—Ç —Å–º–µ—â–µ–Ω–∏–π CropBox –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –û–≤–µ—Ä–ª–µ–π –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π

### **2. –ö—Ä–∞—Å–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –ø–∞–∫–µ—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ**
**–ü—Ä–æ–±–ª–µ–º–∞**: `cannot identify image file <_io.BytesIO ...>`

**–†–µ—à–µ–Ω–∏–µ**:
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `draw_png_bytes()` —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π BytesIO –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞
- ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π `seek(0)` –ø–µ—Ä–µ–¥ `drawImage`
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤

## üîß **–ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**

### **`pil_to_png_bytes(pil_img, opacity)`**
```python
def pil_to_png_bytes(pil_img: Image.Image, opacity: float = 1.0) -> bytes:
    """PIL.Image -> PNG bytes, —Å —É—á—ë—Ç–æ–º –æ–±—â–µ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏."""
    img = pil_img.convert("RGBA")
    if opacity < 0.999:
        r,g,b,a = img.split()
        a = a.point(lambda v: int(v * opacity))
        img = Image.merge("RGBA", (r,g,b,a))
    buf = io.BytesIO()
    img.save(buf, "PNG", optimize=False, compress_level=0)
    return buf.getvalue()
```

### **`draw_png_bytes(c, png_bytes, x, y, w, h)`**
```python
def draw_png_bytes(c, png_bytes: bytes, x, y, w, h):
    """–ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ ‚Äî –ù–û–í–´–ô BytesIO, –∏–Ω–∞—á–µ ReportLab –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å "—Å–µ—Ä–µ–¥–∏–Ω—É" –±—É—Ñ–µ—Ä–∞."""
    bio = io.BytesIO(png_bytes); bio.seek(0)
    c.drawImage(ImageReader(bio), x, y, width=w, height=h, mask='auto')
```

### **`merge_on_page(page, items)`**
```python
def merge_on_page(page, items):
    """–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—á–∏—Ç—ã–≤–∞–µ–º CropBox –∏ Rotate."""
    pw, ph = float(page.mediabox.width), float(page.mediabox.height)

    # CropBox-—Å–º–µ—â–µ–Ω–∏–µ
    crop = page.cropbox
    off_x = float(crop.lower_left[0]); off_y = float(crop.lower_left[1])
    for it in items:
        it["x"] += off_x
        it["y"] += off_y

    overlay_page = make_overlay(pw, ph, items)

    # –ü–æ–≤–æ—Ä–æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    rotation = int(page.get("/Rotate", 0)) % 360
    if rotation:
        try:
            overlay_page.rotate(rotation)
        except Exception:
            overlay_page.rotate_clockwise(rotation)

    page.merge_page(overlay_page)
```

## ‚úÖ **–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**

### **–†–æ—Ç–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü**
- ‚úÖ –û–≤–µ—Ä–ª–µ–π –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `/Rotate: 0¬∞, 90¬∞, 270¬∞`
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –ª—é–±–æ–º –ø–æ–≤–æ—Ä–æ—Ç–µ

### **CropBox –ø–æ–¥–¥–µ—Ä–∂–∫–∞**
- ‚úÖ –£—á–µ—Ç —Å–º–µ—â–µ–Ω–∏–π CropBox –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—Ç—Å—è –Ω–∞ –æ—Ñ—Ñ—Å–µ—Ç—ã
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å PDF, –≥–¥–µ CropBox ‚â† MediaBox

### **PNG –±—É—Ñ–µ—Ä—ã**
- ‚úÖ –ù–æ–≤—ã–π BytesIO –¥–ª—è –∫–∞–∂–¥–æ–≥–æ `drawImage`
- ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π `seek(0)` –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤

### **–ï–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞**
- ‚úÖ –û–¥–∏–Ω–æ—á–Ω—ã–π –∏ –ø–∞–∫–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ª–æ–≥–∏–∫—É
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –æ–¥–∏–Ω–æ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ PNG

## üöÄ **–†–µ–∑—É–ª—å—Ç–∞—Ç**

**–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã:**

- ‚úÖ –ü–µ—á–∞—Ç—å –±–æ–ª—å—à–µ –Ω–µ "—Å—ä–µ–∑–∂–∞–µ—Ç" –Ω–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
- ‚úÖ –ö—Ä–∞—Å–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤ –ø–∞–∫–µ—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã
- ‚úÖ –û–¥–∏–Ω–∞–∫–æ–≤–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –≤ –æ–¥–∏–Ω–æ—á–Ω–æ–º –∏ –ø–∞–∫–µ—Ç–Ω–æ–º —Ä–µ–∂–∏–º–∞—Ö
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ CropBox –∏ —Ä–æ—Ç–∞—Ü–∏–∏
- ‚úÖ –ù–∞–¥–µ–∂–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å PNG –±—É—Ñ–µ—Ä–∞–º–∏

**–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!** üéØ

---

*–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã: 12 –∞–≤–≥—É—Å—Ç–∞ 2025*
*–í–µ—Ä—Å–∏—è: 1.0.1 (Critical Fixes Applied)* 