# üéØ –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üìã **–û–±–∑–æ—Ä**

–§–∏–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—á–∞—Ç–µ–π –∏ –ø–æ–¥–ø–∏—Å–µ–π –Ω–∞ PDF —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö —Å —É—á–µ—Ç–æ–º —Ä–æ—Ç–∞—Ü–∏–∏ –∏ CropBox.

## üîß **–ö–ª—é—á–µ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è**

### **`normalize_rect_visual_to_user(page, x, y, w, h)`**

```python
def normalize_rect_visual_to_user(page, x, y, w, h):
    """
    x,y,w,h ‚Äî –≤ pt –æ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –Ω–∏–∂–Ω–µ–≥–æ-–ª–µ–≤–æ–≥–æ —É–≥–ª–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ user-space —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —É—á—ë—Ç–æ–º /Rotate –∏ CropBox.
    –î–ª—è 90¬∞/270¬∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –º–µ–Ω—è–µ–º w‚Üîh.
    """
    pw = float(page.mediabox.width)
    ph = float(page.mediabox.height)
    rot = int(page.get("/Rotate", 0)) % 360

    if rot == 0:
        nx, ny, nw, nh = x, y, w, h
    elif rot == 90:
        nx = y
        ny = pw - (x + w)
        nw, nh = h, w   # swap
    elif rot == 180:
        nx = pw - (x + w)
        ny = ph - (y + h)
        nw, nh = w, h
    elif rot == 270:
        nx = ph - (y + h)
        ny = x
        nw, nh = h, w   # swap
    else:
        nx, ny, nw, nh = x, y, w, h

    # CropBox offset
    crop = page.cropbox
    nx += float(crop.lower_left[0])
    ny += float(crop.lower_left[1])
    return nx, ny, nw, nh
```

## üìê **–§–æ—Ä–º—É–ª—ã –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è**

### **–†–æ—Ç–∞—Ü–∏—è 0¬∞ (–±–µ–∑ –ø–æ–≤–æ—Ä–æ—Ç–∞):**
```
(x, y, w, h) ‚Üí (x, y, w, h)
```

### **–†–æ—Ç–∞—Ü–∏—è 90¬∞:**
```
(x, y, w, h) ‚Üí (y, pw - (x + w), h, w)
```

### **–†–æ—Ç–∞—Ü–∏—è 180¬∞:**
```
(x, y, w, h) ‚Üí (pw - (x + w), ph - (y + h), w, h)
```

### **–†–æ—Ç–∞—Ü–∏—è 270¬∞:**
```
(x, y, w, h) ‚Üí (ph - (y + h), x, h, w)
```

## üîç **–û—Ç–ª–∞–¥–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

```python
print(f"rot= {int(page.get('/Rotate', 0))}, "
      f"in= ({x:.2f}, {y:.2f}, {w:.2f}, {h:.2f}), "
      f"norm= ({nx:.2f}, {ny:.2f}, {nw:.2f}, {nh:.2f}), "
      f"mb= ({pw:.2f}, {ph:.2f}), "
      f"crop= ({float(page.cropbox.lower_left[0]):.2f}, {float(page.cropbox.lower_left[1]):.2f})")
```

## üöÄ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**

### **–í —Ñ—É–Ω–∫—Ü–∏–∏ merge_on_page:**
```python
def merge_on_page(page, items):
    """–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—á–∏—Ç—ã–≤–∞–µ–º CropBox –∏ Rotate –±–µ–∑ –ø–æ–≤–æ—Ä–æ—Ç–∞ –æ–≤–µ—Ä–ª–µ—è."""
    pw, ph = float(page.mediabox.width), float(page.mediabox.height)

    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
    normalized_items = []
    for i, it in enumerate(items):
        nx, ny, nw, nh = normalize_rect_visual_to_user(page, it["x"], it["y"], it["w"], it["h"])
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        print(f"rot= {int(page.get('/Rotate', 0))}, "
              f"in= ({it['x']:.2f}, {it['y']:.2f}, {it['w']:.2f}, {it['h']:.2f}), "
              f"norm= ({nx:.2f}, {ny:.2f}, {nw:.2f}, {nh:.2f}), "
              f"mb= ({pw:.2f}, {ph:.2f}), "
              f"crop= ({float(page.cropbox.lower_left[0]):.2f}, {float(page.cropbox.lower_left[1]):.2f})")
        
        normalized_items.append({
            "png_bytes": it["png_bytes"],
            "x": nx,
            "y": ny,
            "w": nw,
            "h": nh
        })

    # –°–æ–∑–¥–∞–µ–º –æ–≤–µ—Ä–ª–µ–π —Å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
    overlay_page = make_overlay(pw, ph, normalized_items)

    # –ù–ï –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π - –≤—Å—è –º–∞–≥–∏—è –≤ –ø–µ—Ä–µ—Å—á–µ—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    page.merge_page(overlay_page)
```

## ‚úÖ **–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã**

### **1. –ù–µ –≤—Ä–∞—â–∞–µ–º overlay**
- –û–≤–µ—Ä–ª–µ–π —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ user-space —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –ù–∏–∫–∞–∫–∏—Ö –≤—ã–∑–æ–≤–æ–≤ `overlay_page.rotate()`
- –í—Å—è "–º–∞–≥–∏—è" –≤ –ø–µ—Ä–µ—Å—á–µ—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

### **2. –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤**
- –î–ª—è —Ä–æ—Ç–∞—Ü–∏–∏ 90¬∞/270¬∞ –º–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ `w‚Üîh`
- –î–ª—è —Ä–æ—Ç–∞—Ü–∏–∏ 0¬∞/180¬∞ —Ä–∞–∑–º–µ—Ä—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### **3. –£—á–µ—Ç CropBox**
- –í—Å–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—Ç—Å—è –Ω–∞ CropBox —Å–º–µ—â–µ–Ω–∏—è
- –†–∞–±–æ—Ç–∞–µ—Ç —Å PDF, –≥–¥–µ CropBox ‚â† MediaBox

### **4. –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã**
- –í—Ö–æ–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∑–∞–¥–∞—é—Ç—Å—è –æ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –Ω–∏–∂–Ω–µ–≥–æ-–ª–µ–≤–æ–≥–æ —É–≥–ª–∞
- –†–µ–∑—É–ª—å—Ç–∞—Ç - –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–æ—Ç–∞—Ü–∏–∏

## üéØ **–†–µ–∑—É–ª—å—Ç–∞—Ç**

**–°–∏—Å—Ç–µ–º–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞:**

- ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –≤—Å–µ—Ö —É–≥–ª–æ–≤ —Ä–æ—Ç–∞—Ü–∏–∏
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã** –ø–µ—á–∞—Ç–µ–π –∏ –ø–æ–¥–ø–∏—Å–µ–π
- ‚úÖ **–£—á–µ—Ç CropBox** —Å–º–µ—â–µ–Ω–∏–π
- ‚úÖ **–û—Ç–ª–∞–¥–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –±–µ–∑ –ø–æ–≤–æ—Ä–æ—Ç–∞ overlay

**–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!** üöÄ

---

*–§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è: 12 –∞–≤–≥—É—Å—Ç–∞ 2025*
*–í–µ—Ä—Å–∏—è: 1.0.6 (Final Coordinate System)* 